- name: Load final retry report
  slurp:
    src: "/var/log/kube_dispatcher_final_retry_report.json"
  delegate_to: localhost
  register: final_retry_raw

- name: Parse escalated nodes
  set_fact:
    escalated_nodes: >-
      {{
        final_retry_raw.content
        | b64decode
        | from_json
        | default({})
        | dict2items
        | selectattr('key', 'equalto', 'nodes')
        | map(attribute='value')
        | first
        | selectattr('escalation.triggered', 'equalto', true)
        | map(attribute='host')
        | list
      }}

- name: Load override list
  find:
    paths: "/var/log/kube_override_flags"
    patterns: "*.json"
  delegate_to: localhost
  register: override_files

- name: Read override flags
  slurp:
    src: "{{ item.path }}"
  loop: "{{ override_files.files }}"
  delegate_to: localhost
  register: raw_override_data

- name: Parse override flags
  set_fact:
    override_matrix: >-
      {{
        raw_override_data.results
        | map(attribute='content')
        | map('b64decode')
        | map('from_json')
        | list
        | map(attribute='host')
        | list
      }}

- name: Filter override-eligible nodes
  set_fact:
    override_promotable_nodes: "{{ escalated_nodes | intersect(override_matrix) }}"

- name: Emit override promotion summary
  copy:
    dest: "/var/log/kube_override_promotion_summary.json"
    content: |
      {
        "timestamp": "{{ ansible_date_time.iso8601 }}",
        "override_promotable_nodes": {{ override_promotable_nodes | to_json }},
        "total": {{ override_promotable_nodes | length }}
      }
  delegate_to: localhost
