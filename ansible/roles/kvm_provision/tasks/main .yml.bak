- name: startin vm build
  debug: msg="Stating VM build"

- name: Set fact for existing VMs
  set_fact:
    kvm_delegate: "kvmdc01.morinsoft.ca"
    vm_host: "{{ inventory_hostname }}"
    vm_fqdn: "{{ hostvars[inventory_hostname].ansible_fqdn | default(inventory_hostname + '.' + ansible_domain | default('morinsoft.ca')) }}"

- name: Define virtual machines
  delegate_to: "{{ kvm_delegate}}"
  when: 
   - "'kvmdc01' not in group_names"
  import_tasks: define_vms.yml

- name: Get current epoch time from localhost
  become: false
  shell: date +%s
  register: epoch_result
  delegate_to: localhost
  run_once: true
  changed_when: false

- name: Set VM shutdown poll start time
  set_fact:
    vm_shutdown_start: "{{ epoch_result.stdout | int }}"

- name: Initialize VM state
  set_fact:
    vm_build_state: "undefined"
    vm_timeout: 0
    vm_build_stage: "unknown"

- name: Poll until VM is shut off or timeout
  include_tasks: nested_loop.yml
  when: "'kvm' not in group_names"

- name: Fail if VM did not shut off after polling
  fail:
    msg: "VM {{ vm_host }} did not shut off after polling timeout."
  when: 
    - vm_build_state != "shutdown"
    - (vm_timeout | int) > shutdown_max_timeout

- name: Initialize VM state
  set_fact:
    vm_timeout: 0
    vm_build_stage: "build"
  when: vm_build_state == "shutdown" and (vm_timeout | int) < shutdown_max_timeout

- name: Start virtual machines
  delegate_to: "{{ kvm_delegate}}"
  when: "'kvm' not in group_names"
  import_tasks: start_vms.yml

- name: Wait for SSH availability
  delegate_to: "{{ kvm_delegate}}"
  when: "'kvmdc01' not in group_names"
  import_tasks: wait_for_ssh.yml
